# configs/process.yml
# Main processing configuration with multi-scale support

project_dir: "."

# Multiple hex grids for multi-scale analysis
# Scales from 100 ha to 100,000 ha (larger than FIA's 46,000 ha)
hex_grids:
  - name: "fia"
    path: "data/hex/hex_grid.geojson"
    layer: null

  - name: "100ha"
    path: "data/hex/hex_grid_100ha.geojson"
    layer: null

  - name: "500ha"
    path: "data/hex/hex_grid_500ha.geojson"
    layer: null

  - name: "1kha"
    path: "data/hex/hex_grid_1kha.geojson"
    layer: null

  - name: "5kha"
    path: "data/hex/hex_grid_5kha.geojson"
    layer: null

  - name: "10kha"
    path: "data/hex/hex_grid_10kha.geojson"
    layer: null

  - name: "50kha"
    path: "data/hex/hex_grid_50kha.geojson"
    layer: null

  - name: "100kha"
    path: "data/hex/hex_grid_100kha.geojson"
    layer: null

# Settings for creating hex grids (used by --create-hex)
hex_creation_settings:
  area_ha_list: [100, 500, 1000, 5000, 10000, 50000, 100000]
  clip_to: "data/hex/hex_grid.geojson"  # Use FIA grid as boundary
  exclude_water: "data/hex/Waterbodies_FeaturesToJSON.geojson"
  buffer_km: 0  # No buffer when clipping to existing grid

# Default grid for initial plot assignment
hex_path: "data/hex/hex_grid.geojson"
hex_layer: null

# Choose metric: aglb, carbon, mortality, growth, regeneration
metric: "aglb"

# Metric-specific parameters
metric_params:
  carbon_fraction: 0.5
  dbh_sapling: 2.5
  dbh_tree: 5.0

# Updated processing years (annual FIA stable period)
years: [2020, 2021, 2022, 2023, 2024]
level_window: 5

# Monte Carlo settings
mc_reps: 80             # Number of jitter replicates
jitter_radius_m: 1609.34  # ~1 mile

# Jitter constraints
mask:
  use_hex_union: true
  use_state_constraint: true
  state_geo_path: "data/boundaries/states_5070.geojson"
  state_field: "STATEFP"
  max_reroll: 10

# Run ID (auto-generated if null)
run_id: null

ndvi:
  # Enable/disable NDVI products
  use_modis: true
  use_s2: true
  
  # Window type for temporal aggregation
  window_type: "blocked"  # "blocked" = 5-year windows aligned to FIA design
  
  # Directory paths for NDVI rasters
  modis_dir: "data/processed/ndvi/modis"
  s2_dir: "data/processed/ndvi/s2"
  
  # File naming patterns (use {start} and {end} placeholders)
  modis_pattern: "MODIS_NDVI_5yr_blocked_{start}_{end}.tif"
  s2_pattern: "S2_NDVI_10m_5yr_blocked_{start}_{end}.tif"
  
  # Map FIA measurement years to NDVI file windows
  # Non-overlapping 5-year blocks aligned with FIA panel design
  # Plots measured in year Y get assigned to the block containing Y
  years_to_windows:
    "2000-2004":
      start: 2000
      end: 2004
      has_modis: true
      has_s2: false
    "2005-2009":
      start: 2005
      end: 2009
      has_modis: true
      has_s2: false
    "2010-2014":
      start: 2010
      end: 2014
      has_modis: true
      has_s2: false
    "2015-2019":
      start: 2015
      end: 2019
      has_modis: true
      has_s2: true  # S2 available from 2015+
    "2020-2024":
      start: 2020
      end: 2024
      has_modis: true
      has_s2: true
  
  # Buffer around plot point for extraction (meters)
  # Use 0 for point extraction, or small buffer for averaging
  extraction_buffer_m: 0
  
  # For MODIS (250m), may want to use point or small buffer
  modis_extraction_method: "point"  # "point" or "buffer"
  modis_buffer_m: 125  # half pixel if using buffer
  
  # For Sentinel-2 (10m), point extraction is usually fine
  s2_extraction_method: "point"
  s2_buffer_m: 5

# Modeling configuration
ndvi_modeling:
  # Cross-validation settings
  cv_method: "spatial_hex"  # "spatial_hex", "spatial_state", "random_kfold"
  cv_folds: 5
  cv_holdout_fraction: 0.2
  
  # Model types to fit
  models:
    - "lm"        # Linear model
    - "gam"       # Generalized additive model
    - "rf"        # Random forest (optional, slower)
  
  # Response variable options
  response: "aglb_Mg_per_ha"  # matches column name in your data
  
  # Include PRISM climate as covariates?
  include_climate: true
  
  # Minimum plots per hex for inclusion
  min_plots_per_hex: 3
  
  # Fuzz pressure classes for stratified analysis
  fuzz_pressure_quantiles: [0.25, 0.5, 0.75]

